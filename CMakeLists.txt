cmake_minimum_required(VERSION 3.27.0)

set(CMAKE_CXX_STANDARD 20)
set(CMAKE_BUILD_TYPE Release CACHE STRING "")
set(
	LIBS
	WebFrameworkCore
	WebFrameworkExecutors
	BaseTCPServer
	FileManager
	INIParser
	Localization
	Log
	Networks
	JSON
	SocketStreams
	SHA256
	ThreadPool
	UtilityLibrary
	Databases
	sqlite3
	ssl
	crypto
	CACHE INTERNAL ""
)
set(ADDITIONAL_LIBS "" CACHE INTERNAL "")
set(ADDITIONAL_INCLUDES "" CACHE INTERNAL "")
set(ADDITIONAL_LIB_DIRS "" CACHE INTERNAL "")
option(WITH_LANGUAGES_APIS "Build all languages APIS" ON)
option(WITH_STACKTRACE "Build with Boost::stacktrace" OFF)
set(CXX_API_INSTALL_DESTINATION ${CMAKE_INSTALL_PREFIX}/api/cxx/include)

project(WebFramework VERSION 3.0.12)

install(FILES LICENSE DESTINATION license) # Used in APIs install

if (${WITH_STACKTRACE})
	add_definitions(-D__WITH_STACKTRACE__)
endif()

if (UNIX)
	add_definitions(-D__LINUX__)
	add_compile_options(-fvisibility=hidden)
	
	set(CMAKE_POSITION_INDEPENDENT_CODE ON)

	if (${CMAKE_SYSTEM_NAME} STREQUAL "Android")
		add_definitions(-D__ANDROID__)
	else()
		add_link_options(-rdynamic)
	endif()
else ()
	add_definitions(-DNOMINMAX)

	list(APPEND LIBS crypt32)
endif ()

add_library(
	${PROJECT_NAME} SHARED
	WebFramework/src/Rendering/StandardWebFrameworkDynamicPagesFunctions.cpp
	WebFramework/src/Rendering/WFDPRenderer.cpp
	WebFramework/src/Rendering/MDRenderer.cpp
	WebFramework/src/Exceptions/NotFoundException.cpp
	WebFramework/src/Exceptions/CantFindFunctionException.cpp
	WebFramework/src/Exceptions/CantLoadSourceException.cpp
	WebFramework/src/Exceptions/DynamicPagesSyntaxException.cpp
	WebFramework/src/Exceptions/MissingLoadTypeException.cpp
	WebFramework/src/Exceptions/APIException.cpp
	WebFramework/src/Executors/ResourceExecutor.cpp
	WebFramework/src/LoadBalancer/LoadBalancerServer.cpp
	WebFramework/src/LoadBalancer/Heuristics/BaseLoadBalancerHeuristic.cpp
	WebFramework/src/LoadBalancer/Heuristics/Connections.cpp
	WebFramework/src/LoadBalancer/Heuristics/CXXHeuristic.cpp
	WebFramework/src/LoadBalancer/Heuristics/CCHeuristic.cpp
	WebFramework/src/Proxy/ProxyServer.cpp
	WebFramework/src/Utility/Sources.cpp
	WebFramework/src/Utility/RouteParameters.cpp
	WebFramework/src/Utility/Singletons/HTTPSSingleton.cpp
	WebFramework/src/Utility/BaseConnectionData.cpp
	WebFramework/src/Utility/DynamicLibraries.cpp
	WebFramework/src/Utility/SegfaultHandler.cpp
	WebFramework/src/Managers/DatabasesManager.cpp
	WebFramework/src/Managers/ExecutorsManager.cpp
	WebFramework/src/Web/Servers/BaseWebServer.cpp
	WebFramework/src/Web/Servers/MultithreadedWebServer.cpp
	WebFramework/src/Web/Servers/ThreadPoolWebServer.cpp
	WebFramework/src/Web/Servers/ExecutorServer.cpp
	WebFramework/src/Framework/Config.cpp
	WebFramework/src/Framework/WebFramework.cpp
	WebFramework/src/CAPI/WebFrameworkCAPI.cpp
	WebFramework/src/CAPI/WebFrameworkExecutorsCAPI.cpp
	WebFramework/src/CAPI/WebFrameworkUtilityCAPI.cpp
	WebFramework/src/CAPI/WebFrameworkLocalizationCAPI.cpp
	WebFramework/src/Utility/LargeFileHandlers/BaseLargeBodyHandler.cpp
	WebFramework/src/Utility/LargeFileHandlers/ThreadPoolHandler.cpp
	WebFramework/src/Utility/LargeFileHandlers/MultithreadedHandler.cpp
	WebFramework/src/Utility/AdditionalServerSettings.cpp
	WebFramework/src/Web/HTTPRequestImplementation.cpp
	WebFramework/src/Web/HTTPResponseImplementation.cpp
	WebFramework/src/Databases/DatabaseImplementation.cpp
	WebFramework/src/Databases/TableImplementation.cpp
	WebFramework/src/Databases/SQLResultImplementation.cpp
	WebFramework/src/Databases/SQLValueImplementation.cpp
	WebFramework/src/Executors/CXXExecutor.cpp
	WebFramework/src/Executors/CCExecutor.cpp
)

if (DEFINED ENV{MARCH} AND NOT "$ENV{MARCH}" STREQUAL "")
	target_compile_options(${PROJECT_NAME} PRIVATE -march=$ENV{MARCH})
endif()

if (CMAKE_GENERATOR MATCHES "Visual Studio")
	target_compile_options(${PROJECT_NAME} PUBLIC "/MP")
endif()

add_subdirectory(3rdparty)
add_subdirectory(WebFrameworkCore)
add_subdirectory(WebFrameworkExecutors)
add_subdirectory(BaseTCPServer)
add_subdirectory(FileManager)
add_subdirectory(INIParser)
add_subdirectory(Localization)
add_subdirectory(Log)
add_subdirectory(Networks)
add_subdirectory(SHA256)
add_subdirectory(ThreadPool)
add_subdirectory(UtilityLibrary)
add_subdirectory(Databases)

add_subdirectory(API)

target_include_directories(
	${PROJECT_NAME} PUBLIC
	WebFramework/src/
	WebFrameworkCore/src/
	WebFrameworkCore/vendor/sqlite3/include/
	WebFrameworkExecutors/src/
	BaseTCPServer/src/
	FileManager/src/
	INIParser/src/
	Localization/src/
	Log/src/
	Networks/src/
	Networks/HTTP/src/
	Networks/HTTP/JSON/src/
	SHA256/src/
	ThreadPool/src/
	UtilityLibrary/include/
	${ADDITIONAL_INCLUDES}
)

target_link_directories(
	${PROJECT_NAME} PUBLIC
	${SQLITE_LIBRARY_PATH}
	${ADDITIONAL_LIB_DIRS}
)

target_link_libraries(
	${PROJECT_NAME}
	${LIBS}
	${ADDITIONAL_LIBS}
)

install(
	TARGETS ${PROJECT_NAME} 
	ARCHIVE DESTINATION ${CMAKE_INSTALL_PREFIX}/lib
	LIBRARY DESTINATION ${CMAKE_INSTALL_PREFIX}/lib
	RUNTIME DESTINATION ${CMAKE_INSTALL_PREFIX}/dll
)

install(FILES WebFrameworkConfig.cmake DESTINATION ${CMAKE_INSTALL_PREFIX})
install(FILES FindWebFramework.cmake DESTINATION ${CMAKE_INSTALL_PREFIX})

if (NOT EXISTS ${CMAKE_INSTALL_PREFIX}/WebFrameworkAssets)
	install(DIRECTORY WebFramework/WebFrameworkAssets/ DESTINATION ${CMAKE_INSTALL_PREFIX}/WebFrameworkAssets)
endif ()

install(DIRECTORY WebFramework/certificates DESTINATION ${CMAKE_INSTALL_PREFIX})
install(DIRECTORY schemas DESTINATION ${CMAKE_INSTALL_PREFIX})
