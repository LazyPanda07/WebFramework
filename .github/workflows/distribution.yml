name: Distribution


on:
  release:
  workflow_dispatch:


env:
  dotnet-version: 8.0


jobs:
  pip-package:
    runs-on: ubuntu-latest
    
    steps:
    - name: Get Linux latest release
      uses: robinraju/release-downloader@v1.11
      with:
        repository: ${{ github.repository }}
        latest: true
        extract: true
        fileName: linux.zip

    - name: Get Windows latest release
      uses: robinraju/release-downloader@v1.11
      with:
        repository: ${{ github.repository }}
        latest: true
        extract: true
        fileName: windows.zip

    - name: Create package folder
      run: |
          mkdir package
          mv ReleaseDLL_Linux/api/python_api/* package/
          mkdir package/web_framework_api/dll
          mkdir package/web_framework_api/lib
          mv ReleaseDLL_Windows/dll/*.dll package/web_framework_api/dll/
          mv ReleaseDLL_Linux/lib/*.so package/web_framework_api/lib/

    - name: Build wheel
      working-directory: package
      run: python3 -m build

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: pip-package
        path: package/dist


  nuget-package:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Get Linux latest release
      uses: robinraju/release-downloader@v1.11
      with:
        repository: ${{ github.repository }}
        latest: true
        extract: true
        fileName: linux.zip

    - name: Get Windows latest release
      uses: robinraju/release-downloader@v1.11
      with:
        repository: ${{ github.repository }}
        latest: true
        extract: true
        fileName: windows.zip
        
    - name: Create package folder
      shell: bash
      run: |
          mkdir package
          mkdir -p lib/net${{ env.dotnet-version }}
          mv ReleaseDLL_Windows/api/csharp/WebFrameworkCSharpAPI.dll package/lib/net${{ env.dotnet-version }}
          mv ReleaseDLL_Windows/dll/*.dll package/lib/net${{ env.dotnet-version }}
          mv ReleaseDLL_Linux/lib/*.so package/lib/net${{ env.dotnet-version }}
          cp API/CSharp_API/WebFramework.nuspec package
          cd package
          nuget pack WebFramework.nuspec

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: nuget-package
        path: package/*.nupkg
